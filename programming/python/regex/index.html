<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="lipingcoding">
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>python 正则表达式 - Lipingcoding</title>
        <link href="../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/darcula.min.css">

        <script src="../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../..">Lipingcoding</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Research <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../research/gnn/overview/" class="dropdown-item">GNN</a>
</li>
                                    
<li>
    <a href="../../../research/recsys/overview/" class="dropdown-item">RecSys</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Programming <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../overview/" class="dropdown-item">python</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a href="https://github.com/lipingcoding/blog/edit/master/docs/programming/python/regex.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#_1" class="nav-link">流派</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#python" class="nav-link">Python 正则表达式理论</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<p>市面上几乎所有讲正则表达式的书都不是专门用 python 讲的, 最多用一两章内容介绍一下 python 正则表达式的用法. 一般的正则表达式理论或者各个流派之间的差异对于data science 时代只用 python 的人来说完全没有必要了解.  本文专门针对 python 讲解正则表达式, 从实践到理论全贯通, 主要参考 Jeffrey Friedl 的&lt;精通正则表达式&gt; 和 &lt;正则指引&gt;</p>
<!-- more -->

<p>正则表达式, 学习曲线虽然陡峭, 但是一旦学会, 非常有用, 能极大提高效率. </p>
<h1 id="_1">流派</h1>
<p>首先, python 属于传统型 NFA, 之所以说"传统型", 是因为, 为了符合 POSIX 标准, 后来通过修改, 得到了新型的 NFA. 后面所说的 NFA 一律指传统型 NFA.  NFA 可以理解为表达式主导. 与 NFA 相对的是另外一种 DFA. NFA与 DFA 的差别, 不需要太多了解. 但是我们必须要了解传统型 NFA匹配的过程, 这是因为: 如同 C++ 中的逻辑运算一样, 匹配的过程是短路的, 也就是说一旦匹配成功, 就不再继续匹配了,  这样的话, 如果有多个解的话, 返回的不一定是你想要的那一种. 所以我们务必弄清楚匹配的过程. 不过我们并不需要彻底弄清楚具体的匹配过程, 只需要总结出若干原则, 帮助我们判断如果匹配成功, 得到的到底是哪个解. </p>
<h3 id="nfa">传统型 NFA的原则 (功力尚浅, 参考&lt;精通正则表达式&gt;)</h3>
<p>表达式主导</p>
<p>最左最长</p>
<h3 id="_2">编码</h3>
<p>编码问题本身就比较复杂, 加上 python2 和python3 的编码方式又有所区别, 本文只讨论 python 3. </p>
<p>先理清下常见的编码方式, ASCII ,GBK, Unicode 编码.</p>
<p>ASCII码用 1 个字节也就是 128 种可能, 这足以表示英文字母、半角数字、半角标点、半角空格等不可见符号. Unicode编码包含了几乎所有语言的字符. 常见的 utf-8, utf-16都是 unicode 的一种存储格式.   Python3 中默认的字符串编码就是 unicode. </p>
<h3 id="_3">转义</h3>
<p>一个正则表达式需要经过两次转义, 先后是字符串转义和正则转义. 举例</p>
<p>为了匹配 6位数字, 我们需要的正则表达式是 <code>\d{6}</code>, 这里之所以需要 '\', 就是因为对 'd' 进行转义, 使其具有特殊意义. 但在 python 中, 我们不能直接写 '\d{6}'. 因为这是一个字符串, 对于字符串来说, '\' 具有特殊意义, 要想得到一个 '\', 需要再加一个'\', 也就是 '\\d{6}'</p>
<p>Python3 引入了原生字符串的概念, <code>r'str'</code> 代表的就是 str 本身, python 不再进行字符串转义.  所以上面的例子在 python3 中可以直接写成 <code>r'\d{6}'</code> . </p>
<h1 id="python">Python 正则表达式理论</h1>
<h3 id="_4">模式</h3>
<h5 id="_5">单行模式与多行模式</h5>
<p>其实单行模式与多行模式没有任何关系. 如果你不指定的话, 会采用默认模式. </p>
<p>单行模式改变的是 '.' 的匹配, 默认模式下, '.' 能匹配除换行符以外的所有字符, 单行模式下, '.' 能匹配一切字符.  多行模式改变的 '^' 与 '\$'  . 默认模式下, '^' 和 '\$' 只能匹配整个字符串的开头和结尾, 不管中间有没有换行符, 可以理解为 "单行模式" . 多行模式下, '^' 和 '\$' 能真真匹配每一行. </p>
<h5 id="ascii-unicode">ASCII 与 unicode 模式</h5>
<p>此外, 正则表达式的匹配模式也有 ASCII 与 unicode 模式之分. 这主要是 <code>\w</code>  <code>\d</code>  <code>\s</code> 所能代表的字符的区别.  python3 默认 unicode 模式, 可以用 (?a) 显式指定 ASCII 模式. </p>
<p>ASCII模式下 \w 能代表 ASCII 编码中的单词字符, 也就是英文字母、半角数字、下划线. 类似地, \d 能代表半角数字. \s 能代表半角空格等不可见字符. </p>
<p>unicode 模式下 \w 能代表 unicode 编码中的单词字符, 包括英文字母、中文、全半角数字、下划线. \d 能代表全半角数字 . \s能匹配任意空白不可见符号. </p>
<h5 id="_6">模式指定与作用范围</h5>
<p>模式指定有两种方式, 一种是在正则表达式中, 通过模式修饰符(如?m)来指定, 多个模式修饰符可以连写, 如 (?mi). 另一种是通过预定义的常量(如 re.S) 来指定, 多个预定义的常量可以通过 '|' 相连, 如 re.M|re.I . 前一种方法可以通过括号指定范围, 但是后一种范围只能是整个正则表达式.   注意到, 模式修饰符都是小写, 预定义的常量都是大写. </p>
<h3 id="_7">锚点</h3>
<h5 id="b">单词边界 \b</h5>
<p>\b 代表这个位置两侧中, 一侧有 \w 字符, 一侧没有. 由于 \w 在不同匹配模式下, 所能匹配的字符不同, 所以 \b 在不同模式(指 ASCII 与 Unicode) 下意义也不一样. </p>
<h5 id="_8">行边界</h5>
<p>默认模式下, '^' 和 '\$' 只能匹配整个字符串的开头和结尾, 不管中间有没有换行符, 可以理解为 "单行模式" . 多行模式下, '^' 和 '\$' 能真真匹配每一行. </p>
<p>但是有时候, 我们同时需要这两种功能. 这时可以使有 '\A' 和 '\Z' , 不管在哪种模式下, 它们都匹配整个字符串的开头和结尾. </p>
<h5 id="_9">环视</h5>
<p>环视分为肯定和否定(否定只需要将 '=' 改成 '!' 即可), 又有左右顺序之分, 所以总共有 4 种. 环视有两种功能, 一种是作为锚点, 像单词边界一样, 确定位置. 另一种是, 用来排除. </p>
<p>Python 否定环视时, 长度必须确定, 也就是说, 不仅不能用量词, 如果用到多选结构, 各选项之间长度也必须相等. </p>
<h6 id="_10">作为锚点</h6>
<p>一个例子就可以说清, 比如我想把 wanglpsite 换成 wanglp'site</p>
<p>只需要 <code>re.sub(r'(?&lt;=wanglp)(?=site)',"'",'wanglpsite')</code>. 分别匹配的是 'wanglp' 右边, 'site' 左边的那个位置. </p>
<h6 id="_11">用来排除</h6>
<p>比如 '(?!3)\d' 就能匹配 除 3 以外的 0-9. </p>
<p>再看一个例子, 要想匹配 <code>&lt;p&gt;Billions &lt;p&gt; and Billions &lt;/p&gt;</code> 中的 <code>&lt;p&gt; and Billions &lt;/p&gt;</code> </p>
<p><code>&lt;p&gt;.*?&lt;/p&gt;</code> 不行,  因为会匹配到 <code>&lt;p&gt;Billions &lt;p&gt; and Billions &lt;/p&gt;</code> </p>
<p>```python 
In [39]: str = '<p>Billions <p> and Billions </p>'</p>
<p>In [40]: pattern = r'<p>(?:(?!<p>).)*?</p>'</p>
<p>In [41]: r = re.search(pattern, str)</p>
<p>In [42]: r.group()
Out[42]: '<p> and Billions </p>'</p>
<pre><code>


### 捕获分组与引用

凡是 ( ) 包裹的都是分组, 凡是分组如果没有 (?: ) 都是捕获分组,捕获分组从左到右依次编号为1, 2, ...     

在 python 中捕获分组主要有三种用途, 第一种是为了在最后想要获得分组匹配的结果, 第二种是反向引用, 第三种是用于 re.sub. python 支持同时使用命名分组和数字分组, 但为了格式的统一, 最好只用一种. 为了比较两种方式的具体使用, 后文对两种方式都进行了展示. 

- 用途一

```python
In [2]: s = re.search(r'(?P&lt;year&gt;\d{4})-(?P&lt;month&gt;\d{2})-(\d{2})','2018-11-12')

In [3]: s.groups() # 返回(group(1), group(2),..)
Out[3]: ('2018', '11', '12')

In [4]: s.group()
Out[4]: '2018-11-12'

In [5]: s.group('month')
Out[5]: '11'

In [6]: s.group(0) # 同时支持命名分组和数字分组
Out[6]: '2018-11-12'

In [7]: s.group(2)
Out[7]: '11'

</code></pre>
<ul>
<li>用途二: 反向引用 </li>
</ul>
<p>```python 
In [48]: s = re.search(r'(?P<year>\d{4})-(?P<month>\d{2})-(\2)','2018-11-12 2018-11-11')</p>
<p>In [49]: s.groups()
Out[49]: ('2018', '11', '11')</p>
<p>In [50]: s = re.search(r'(?P<year>\d{4})-(?P<month>\d{2})-(?P=month)','2018-11-12 2018-11-11')</p>
<p>In [51]: s.groups()
Out[51]: ('2018', '11') # 注意, 利用?P=month反向引用的分组没有被捕获</p>
<p>In [68]: s.start(2)
Out[68]: 16</p>
<p>In [8]: s = re.search(r'(\d{4})-(\d{2})-(\2)','2018-11-12 2018-11-11')  # 综合来看, 这种方法最好</p>
<p>In [9]: s.groups()
Out[9]: ('2018', '11', '11')</p>
<pre><code>
- 用途三:re.sub


```python
In [55]: re.sub(r'(?P&lt;year&gt;\d{4})-(?P&lt;month&gt;\d{2})-(\d{2})',r'\1-\3-\2','2018-11-12')
Out[55]: '2018-12-11'

In [56]: re.sub(r'(?P&lt;year&gt;\d{4})-(?P&lt;month&gt;\d{2})-(\d{2})',r'\g&lt;year&gt;-\3-\g&lt;month&gt;','2018-11-12')
Out[56]: '2018-12-11'
</code></pre>
<p>从上面三组例子可以看出, 两种方式完全可以混用, 只是反向引用时捕获有点问题, 所以, 最好的方法是全用数字. </p>
<h3 id="python-re-api">python re api</h3>
<p>python 中使用正则表达式有两种方式, 一种是函数式, 一种是面向对象式.  函数式就是直接调用 re 中提供的 search, findall 等函数, 面向对象式就是将正则表达式 先 compile 成一个对象, 然后, 将这个对象传给 search, findall 等函数. 如果需要多次匹配, 则后一种效率更高. </p>
<h5 id="research">re.search</h5>
<p>re.search 如果能匹配, 返回一个 MatchObject, 否则返回 None.  假设 result 是一个 MatchObject. </p>
<h5 id="rematch">re.match</h5>
<p>re.match 是特殊的 search,  re.match(r'regex', str) 相当于 re. search(r'\Aregex', str). </p>
<h5 id="refindall">re.findall</h5>
<p>re.findall 会返回一个不相交的匹配结果的 list. 这里有两点需要注意. 第一, <strong>不相交</strong>, 这说明, re.findall 并不是真的 find all, 例如</p>
<p>```python </p>
<p>In [13]: re.findall(r'121', '12121')
Out[13]: ['121']</p>
<p>```</p>
<p>第二, 对于匹配结果的理解. 如果正则表达式中有捕获分组, 则匹配结果是一个由捕获内容组成的元组,也就是 (group(1), group(2),...).  如果正则表达式中没有捕获分组, 则匹配结果就是整个匹配到的内容, 也就是 group(0), 但事实上, 这时候你无法知道完整匹配, 不过可以在整个正则表达式外面加一个 ( ).</p>
<h5 id="refinditer">re.finditer</h5>
<p>返回迭代器, 避免匹结果过多, 一次性匹配耗时太长. </p>
<h3 id="resub">re.sub</h3>
<p>前文已展示过用法 </p>
<hr>王礼萍  原创<br>

 更多内容请访问 https://wanglp.site</div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js" defer></script>
        <script src="../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
